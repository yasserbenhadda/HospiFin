<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomAIService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dashboard</a> &gt; <a href="index.source.html" class="el_package">com.hospital.dashboard.service</a> &gt; <span class="el_source">CustomAIService.java</span></div><h1>CustomAIService.java</h1><pre class="source lang-java linenums">package com.hospital.dashboard.service;

import com.hospital.dashboard.model.*;
import com.hospital.dashboard.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
<span class="fc" id="L14">public class CustomAIService {</span>

<span class="fc" id="L16">    private enum Language {</span>
<span class="fc" id="L17">        FR, EN</span>
    }

<span class="fc" id="L20">    private static final Map&lt;Language, Map&lt;String, String&gt;&gt; TEMPLATES = new HashMap&lt;&gt;();</span>

    static {
<span class="fc" id="L23">        Map&lt;String, String&gt; fr = new HashMap&lt;&gt;();</span>
<span class="fc" id="L24">        fr.put(&quot;STAFF_COUNT&quot;, &quot;üë• Nous avons actuellement {0} membres du personnel hospitalier.&quot;);</span>
<span class="fc" id="L25">        fr.put(&quot;MED_COUNT&quot;, &quot;üíä Le stock compte {0} types de m√©dicaments diff√©rents.&quot;);</span>
<span class="fc" id="L26">        fr.put(&quot;CONS_COUNT&quot;, &quot;üì¶ Nous g√©rons {0} r√©f√©rences de consommables m√©dicaux.&quot;);</span>
<span class="fc" id="L27">        fr.put(&quot;PROJECT_OPINION&quot;,</span>
                &quot;üè• [Avis Projet] : L''h√¥pital est fonctionnel mais sous tension.\nüëâ Explication : {0} {1}&quot;);
<span class="fc" id="L29">        fr.put(&quot;RATIO_CRITICAL&quot;,</span>
                &quot;Le ratio personnel/patient est critique ({0}). Cela indique une surcharge de travail structurelle.&quot;);
<span class="fc" id="L31">        fr.put(&quot;RATIO_STABLE&quot;, &quot;Le ratio personnel est stable, permettant une prise en charge correcte.&quot;);</span>
<span class="fc" id="L32">        fr.put(&quot;STOCK_LOW&quot;,</span>
                &quot;De plus, le stock de m√©dicaments est FAIBLE, ce qui risque de provoquer des ruptures de soins.&quot;);
<span class="fc" id="L34">        fr.put(&quot;FORECAST_HEADER&quot;, &quot;üîÆ [Pr√©visions &amp; Alertes] :\n&quot;);</span>
<span class="fc" id="L35">        fr.put(&quot;ALERT_SURGERY&quot;,</span>
                &quot;‚ö†Ô∏è ALERTE ROUGE : Les co√ªts de Chirurgie explosent (+{0}%).\n   -&gt; Cause probable : Augmentation du prix des proth√®ses ou volume d''actes non r√©gul√©.\n&quot;);
<span class="fc" id="L37">        fr.put(&quot;ALERT_STAFF&quot;,</span>
                &quot;‚ö†Ô∏è ALERTE ORANGE : Sous-effectif d√©tect√©.\n   -&gt; Cons√©quence : Risque accru d''erreurs m√©dicales et de burnout du personnel.\n&quot;);
<span class="fc" id="L39">        fr.put(&quot;NO_RISK&quot;, &quot;‚úÖ Aucun risque majeur d√©tect√©. Les indicateurs sont dans le vert.&quot;);</span>
<span class="fc" id="L40">        fr.put(&quot;SOLUTIONS_HEADER&quot;, &quot;üõ†Ô∏è [Solutions Recommand√©es] :\n&quot;);</span>
<span class="fc" id="L41">        fr.put(&quot;SOL_SURGERY&quot;,</span>
                &quot;Pour la Chirurgie :\n1. üìâ Audit des fournisseurs (Impact: -15% co√ªts) -&gt; Identifiez les √©carts de prix injustifi√©s.\n2. üè• Ambulatoire (Impact: Lib√®re des lits) -&gt; R√©duit les co√ªts d''h√©bergement.\n3. ü§ù Ren√©gociation (Impact: Imm√©diat) -&gt; Faites jouer la concurrence.\n&quot;);
<span class="fc" id="L43">        fr.put(&quot;SOL_STAFF&quot;,</span>
                &quot;\nPour le Personnel :\n1. üßë‚Äç‚öïÔ∏è Int√©rimaires (Impact: Rapide) -&gt; Soulage l''√©quipe imm√©diatement.\n2. üìÖ Optimisation IA (Impact: Structurel) -&gt; Mieux r√©partir la charge existante.\n3. üõèÔ∏è Fermeture de lits (Impact: Drastique) -&gt; √Ä utiliser en dernier recours pour la s√©curit√©.\n&quot;);
<span class="fc" id="L45">        fr.put(&quot;DOC_OPINION&quot;,</span>
                &quot;üë®‚Äç‚öïÔ∏è [Avis Docteur] : Nous avons {0} patients. Dur√©e moyenne de s√©jour : {1} jours. Je recommande de r√©duire la dur√©e pour limiter les infections.&quot;);
<span class="fc" id="L47">        fr.put(&quot;ACC_OPINION&quot;,</span>
                &quot;üìä [Avis Comptable] : Revenu total : {0} ‚Ç¨. Alerte : La Chirurgie augmente de {1}%. C''est critique pour la rentabilit√©.&quot;);
<span class="fc" id="L49">        fr.put(&quot;STRATEGY&quot;,</span>
                &quot;üí° [Strat√©gie] : Pour √©viter la hausse de 7% en Chirurgie :\n1. Ren√©gocier les proth√®ses.\n2. Passer 20% en ambulatoire.\n3. R√©duire le gaspillage.&quot;);
<span class="fc" id="L51">        fr.put(&quot;DEFAULT&quot;, &quot;Je peux analyser le Projet, les Pr√©visions, donner des Alertes ou proposer des Solutions.&quot;);</span>

<span class="fc" id="L53">        Map&lt;String, String&gt; en = new HashMap&lt;&gt;();</span>
<span class="fc" id="L54">        en.put(&quot;STAFF_COUNT&quot;, &quot;üë• We currently have {0} hospital staff members.&quot;);</span>
<span class="fc" id="L55">        en.put(&quot;MED_COUNT&quot;, &quot;üíä The inventory includes {0} different types of medications.&quot;);</span>
<span class="fc" id="L56">        en.put(&quot;CONS_COUNT&quot;, &quot;üì¶ We manage {0} references of medical consumables.&quot;);</span>
<span class="fc" id="L57">        en.put(&quot;PROJECT_OPINION&quot;,</span>
                &quot;üè• [Project Opinion]: The hospital is functional but under pressure.\nüëâ Explanation: {0} {1}&quot;);
<span class="fc" id="L59">        en.put(&quot;RATIO_CRITICAL&quot;, &quot;Staff-to-patient ratio is critical ({0}). This indicates structural overwork.&quot;);</span>
<span class="fc" id="L60">        en.put(&quot;RATIO_STABLE&quot;, &quot;Staffing is stable, allowing for proper care.&quot;);</span>
<span class="fc" id="L61">        en.put(&quot;STOCK_LOW&quot;, &quot;Also, medication stock is LOW, risking care interruptions.&quot;);</span>
<span class="fc" id="L62">        en.put(&quot;FORECAST_HEADER&quot;, &quot;üîÆ [Forecasts &amp; Warnings]:\n&quot;);</span>
<span class="fc" id="L63">        en.put(&quot;ALERT_SURGERY&quot;,</span>
                &quot;‚ö†Ô∏è RED ALERT: Surgery costs are exploding (+{0}%).\n   -&gt; Probable Cause: Rising prosthetics prices or unregulated procedure volume.\n&quot;);
<span class="fc" id="L65">        en.put(&quot;ALERT_STAFF&quot;,</span>
                &quot;‚ö†Ô∏è ORANGE ALERT: Understaffing detected.\n   -&gt; Consequence: Increased risk of medical errors and staff burnout.\n&quot;);
<span class="fc" id="L67">        en.put(&quot;NO_RISK&quot;, &quot;‚úÖ No major risks detected. Indicators are green.&quot;);</span>
<span class="fc" id="L68">        en.put(&quot;SOLUTIONS_HEADER&quot;, &quot;üõ†Ô∏è [Recommended Solutions]:\n&quot;);</span>
<span class="fc" id="L69">        en.put(&quot;SOL_SURGERY&quot;,</span>
                &quot;For Surgery:\n1. üìâ Supplier Audit (Impact: -15% costs) -&gt; Identify unjustified price variances.\n2. üè• Outpatient Shift (Impact: Frees beds) -&gt; Reduces accommodation costs.\n3. ü§ù Renegotiation (Impact: Immediate) -&gt; Leverage competition.\n&quot;);
<span class="fc" id="L71">        en.put(&quot;SOL_STAFF&quot;,</span>
                &quot;\nFor Staffing:\n1. üßë‚Äç‚öïÔ∏è Temp Staff (Impact: Fast) -&gt; Relieves the team immediately.\n2. üìÖ AI Optimization (Impact: Structural) -&gt; Better distribute existing load.\n3. üõèÔ∏è Close Beds (Impact: Drastic) -&gt; Use as last resort for safety.\n&quot;);
<span class="fc" id="L73">        en.put(&quot;DOC_OPINION&quot;,</span>
                &quot;üë®‚Äç‚öïÔ∏è [Doctor Opinion]: We have {0} patients. Average stay duration: {1} days. I recommend reducing the stay duration to minimize infection risks.&quot;);
<span class="fc" id="L75">        en.put(&quot;ACC_OPINION&quot;,</span>
                &quot;üìä [Accountant Opinion]: Total Revenue: {0} ‚Ç¨. Warning: Surgery costs are up by {1}%. This is critical for profitability.&quot;);
<span class="fc" id="L77">        en.put(&quot;STRATEGY&quot;,</span>
                &quot;üí° [Strategy]: To avoid the 7% Surgery increase:\n1. Renegotiate prosthetics contracts.\n2. Shift 20% to outpatient care.\n3. Reduce waste.&quot;);
<span class="fc" id="L79">        en.put(&quot;DEFAULT&quot;, &quot;I can analyze the Project, Forecasts, give Warnings or propose Solutions.&quot;);</span>

<span class="fc" id="L81">        TEMPLATES.put(Language.FR, fr);</span>
<span class="fc" id="L82">        TEMPLATES.put(Language.EN, en);</span>
<span class="fc" id="L83">    }</span>

    @Autowired
    private PatientRepository patientRepository;

    @Autowired
    private HospitalStayRepository stayRepository;

    @Autowired
    private MedicalActRepository medicalActRepository;

    @Autowired
    private MedicationRepository medicationRepository;

    @Autowired
    private ConsumableRepository consumableRepository;

    @Autowired
    private PersonnelRepository personnelRepository;

<span class="fc" id="L103">    private Map&lt;String, Object&gt; trainedModel = new HashMap&lt;&gt;();</span>
<span class="fc" id="L104">    private boolean isTrained = false;</span>

    public Map&lt;String, Object&gt; trainModel() {
        // 1. Aggregate Real Data
<span class="fc" id="L108">        long patientCount = patientRepository.count();</span>
<span class="fc" id="L109">        List&lt;HospitalStay&gt; stays = stayRepository.findAll();</span>
<span class="fc" id="L110">        List&lt;MedicalAct&gt; acts = medicalActRepository.findAll();</span>
<span class="fc" id="L111">        long medicationCount = medicationRepository.count();</span>
<span class="fc" id="L112">        long consumableCount = consumableRepository.count();</span>
<span class="fc" id="L113">        long personnelCount = personnelRepository.count();</span>

<span class="fc" id="L115">        BigDecimal totalRevenue = BigDecimal.ZERO;</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        for (HospitalStay stay : stays) {</span>
<span class="nc bnc" id="L117" title="All 6 branches missed.">            if (stay.getEndDate() != null &amp;&amp; stay.getStartDate() != null &amp;&amp; stay.getDailyRate() != null) {</span>
<span class="nc" id="L118">                long days = stay.getEndDate().toEpochDay() - stay.getStartDate().toEpochDay();</span>
<span class="nc" id="L119">                totalRevenue = totalRevenue.add(stay.getDailyRate().multiply(BigDecimal.valueOf(days)));</span>
            }
<span class="nc" id="L121">        }</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        for (MedicalAct act : acts) {</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">            if (act.getCost() != null) {</span>
<span class="nc" id="L124">                totalRevenue = totalRevenue.add(act.getCost());</span>
            }
<span class="nc" id="L126">        }</span>

<span class="fc" id="L128">        double avgStayDuration = stays.stream()</span>
<span class="pc bnc" id="L129" title="All 4 branches missed.">                .filter(s -&gt; s.getEndDate() != null &amp;&amp; s.getStartDate() != null)</span>
<span class="pc" id="L130">                .mapToLong(s -&gt; s.getEndDate().toEpochDay() - s.getStartDate().toEpochDay())</span>
<span class="fc" id="L131">                .average().orElse(0.0);</span>

        // 2. Simulate/Calculate Trends (Heuristic for Demo)
<span class="fc" id="L134">        Map&lt;String, Double&gt; trends = new HashMap&lt;&gt;();</span>
<span class="fc" id="L135">        trends.put(&quot;Chirurgie&quot;, 7.0); // +7%</span>
<span class="fc" id="L136">        trends.put(&quot;Cardiologie&quot;, 2.5);</span>
<span class="fc" id="L137">        trends.put(&quot;Maternit√©&quot;, -1.0);</span>

        // 3. Advanced Metrics
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        double staffToPatientRatio = patientCount &gt; 0 ? (double) personnelCount / patientCount : 0.0;</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        String stockStatus = medicationCount &lt; 50 ? &quot;LOW&quot; : &quot;NORMAL&quot;;</span>

        // 4. Store &quot;Learned&quot; Knowledge
<span class="fc" id="L144">        trainedModel.put(&quot;patientCount&quot;, patientCount);</span>
<span class="fc" id="L145">        trainedModel.put(&quot;totalRevenue&quot;, totalRevenue);</span>
<span class="fc" id="L146">        trainedModel.put(&quot;avgStayDuration&quot;, avgStayDuration);</span>
<span class="fc" id="L147">        trainedModel.put(&quot;stayCount&quot;, stays.size());</span>
<span class="fc" id="L148">        trainedModel.put(&quot;actCount&quot;, acts.size());</span>
<span class="fc" id="L149">        trainedModel.put(&quot;medicationCount&quot;, medicationCount);</span>
<span class="fc" id="L150">        trainedModel.put(&quot;consumableCount&quot;, consumableCount);</span>
<span class="fc" id="L151">        trainedModel.put(&quot;personnelCount&quot;, personnelCount);</span>
<span class="fc" id="L152">        trainedModel.put(&quot;trends&quot;, trends);</span>
<span class="fc" id="L153">        trainedModel.put(&quot;staffToPatientRatio&quot;, staffToPatientRatio);</span>
<span class="fc" id="L154">        trainedModel.put(&quot;stockStatus&quot;, stockStatus);</span>

<span class="fc" id="L156">        isTrained = true;</span>

<span class="fc" id="L158">        return trainedModel;</span>
    }

    public boolean isTrained() {
<span class="fc" id="L162">        return isTrained;</span>
    }

    public String getAnswer(String question) {
<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (!isTrained) {</span>
<span class="fc" id="L167">            return &quot;Je ne suis pas encore entra√Æn√©. Veuillez cliquer sur 'Entra√Æner le mod√®le' d'abord. / I am not trained yet. Please click 'Train Model' first.&quot;;</span>
        }

<span class="fc" id="L170">        String q = question.toLowerCase();</span>
<span class="fc" id="L171">        boolean isEnglish = isEnglish(q);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">        Language lang = isEnglish ? Language.EN : Language.FR;</span>

<span class="fc" id="L174">        return getAnswerInternal(q, lang);</span>
    }

    private String getAnswerInternal(String q, Language lang) {
        // --- SPECIFIC DATA ---
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (matchesAny(q, &quot;personnel&quot;, &quot;staff&quot;, &quot;equipe&quot;, &quot;team&quot;)) {</span>
<span class="fc" id="L180">            return format(lang, &quot;STAFF_COUNT&quot;, trainedModel.get(&quot;personnelCount&quot;));</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">        } else if (matchesAny(q, &quot;medicament&quot;, &quot;medication&quot;, &quot;pharmacie&quot;, &quot;drug&quot;, &quot;pharmacy&quot;)) {</span>
<span class="fc" id="L182">            return format(lang, &quot;MED_COUNT&quot;, trainedModel.get(&quot;medicationCount&quot;));</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">        } else if (matchesAny(q, &quot;consommable&quot;, &quot;materiel&quot;, &quot;consumable&quot;, &quot;material&quot;, &quot;supply&quot;)) {</span>
<span class="fc" id="L184">            return format(lang, &quot;CONS_COUNT&quot;, trainedModel.get(&quot;consumableCount&quot;));</span>
        }
        // --- GENERAL PREDICTIONS &amp; WARNINGS ---
<span class="fc bfc" id="L187" title="All 2 branches covered.">        else if (matchesAny(q, &quot;prevision&quot;, &quot;futur&quot;, &quot;avenir&quot;, &quot;demain&quot;, &quot;prediction&quot;, &quot;warning&quot;, &quot;alerte&quot;, &quot;danger&quot;,</span>
                &quot;forecast&quot;, &quot;future&quot;, &quot;tomorrow&quot;, &quot;alert&quot;)) {
<span class="fc" id="L189">            return getForecastsWithWarnings(lang);</span>
        }
        // --- SOLUTIONS ---
<span class="fc bfc" id="L192" title="All 2 branches covered.">        else if (matchesAny(q, &quot;solution&quot;, &quot;resoudre&quot;, &quot;fix&quot;, &quot;corriger&quot;, &quot;aide&quot;, &quot;solve&quot;, &quot;help&quot;)) {</span>
<span class="fc" id="L193">            return getSolutions(lang);</span>
        }
        // --- PROJECT OPINION ---
<span class="fc bfc" id="L196" title="All 2 branches covered.">        else if (matchesAny(q, &quot;avis&quot;, &quot;projet&quot;, &quot;opinion&quot;, &quot;general&quot;, &quot;status&quot;, &quot;etat&quot;, &quot;project&quot;, &quot;state&quot;)) {</span>
<span class="fc" id="L197">            return getProjectOpinion(lang);</span>
        }
        // --- DOCTOR PERSONA ---
<span class="fc bfc" id="L200" title="All 2 branches covered.">        else if (matchesAny(q, &quot;avis&quot;, &quot;medical&quot;, &quot;sante&quot;, &quot;patient&quot;, &quot;docteur&quot;, &quot;doctor&quot;, &quot;medecin&quot;, &quot;health&quot;)) {</span>
<span class="fc" id="L201">            return getDoctorOpinion(lang);</span>
        }
        // --- ACCOUNTANT PERSONA ---
<span class="fc bfc" id="L204" title="All 2 branches covered.">        else if (matchesAny(q, &quot;avis&quot;, &quot;financier&quot;, &quot;finance&quot;, &quot;comptable&quot;, &quot;cout&quot;, &quot;argent&quot;, &quot;budget&quot;, &quot;depense&quot;,</span>
                &quot;paye&quot;, &quot;financial&quot;, &quot;accountant&quot;, &quot;cost&quot;, &quot;money&quot;, &quot;expense&quot;)) {
<span class="fc" id="L206">            return getAccountantOpinion(lang);</span>
        }
        // --- STRATEGIC ADVICE ---
<span class="fc bfc" id="L209" title="All 2 branches covered.">        else if (matchesAny(q, &quot;augmentation&quot;, &quot;hausse&quot;, &quot;chirurgie&quot;, &quot;skip&quot;, &quot;eviter&quot;, &quot;reduire&quot;, &quot;increase&quot;, &quot;rise&quot;,</span>
                &quot;surgery&quot;, &quot;avoid&quot;, &quot;reduce&quot;)) {
<span class="fc" id="L211">            return format(lang, &quot;STRATEGY&quot;);</span>
        } else {
<span class="fc" id="L213">            return format(lang, &quot;DEFAULT&quot;);</span>
        }
    }

    private String getProjectOpinion(Language lang) {
<span class="fc" id="L218">        double ratio = getSafeDouble(trainedModel, &quot;staffToPatientRatio&quot;);</span>
<span class="fc" id="L219">        String stock = getSafeString(trainedModel, &quot;stockStatus&quot;);</span>

<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        String ratioText = format(lang, ratio &lt; 0.2 ? &quot;RATIO_CRITICAL&quot; : &quot;RATIO_STABLE&quot;, String.format(&quot;%.2f&quot;, ratio));</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        String stockText = &quot;LOW&quot;.equals(stock) ? format(lang, &quot;STOCK_LOW&quot;) : &quot;&quot;;</span>

<span class="fc" id="L224">        return format(lang, &quot;PROJECT_OPINION&quot;, ratioText, stockText);</span>
    }

    private String getForecastsWithWarnings(Language lang) {
<span class="fc" id="L228">        Map&lt;String, Object&gt; trends = getSafeMap(trainedModel, &quot;trends&quot;);</span>
<span class="fc" id="L229">        double surgeryTrend = getSafeDouble(trends, &quot;Chirurgie&quot;);</span>
<span class="fc" id="L230">        double ratio = getSafeDouble(trainedModel, &quot;staffToPatientRatio&quot;);</span>

<span class="fc" id="L232">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L233">        sb.append(format(lang, &quot;FORECAST_HEADER&quot;));</span>

<span class="fc" id="L235">        boolean hasAlert = false;</span>
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (surgeryTrend &gt; 5.0) {</span>
<span class="fc" id="L237">            sb.append(format(lang, &quot;ALERT_SURGERY&quot;, surgeryTrend));</span>
<span class="fc" id="L238">            hasAlert = true;</span>
        }

<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (ratio &lt; 0.2) {</span>
<span class="fc" id="L242">            sb.append(format(lang, &quot;ALERT_STAFF&quot;));</span>
<span class="fc" id="L243">            hasAlert = true;</span>
        }

<span class="pc bpc" id="L246" title="1 of 2 branches missed.">        if (!hasAlert) {</span>
<span class="nc" id="L247">            sb.append(format(lang, &quot;NO_RISK&quot;));</span>
        }

<span class="fc" id="L250">        return sb.toString();</span>
    }

    private String getSolutions(Language lang) {
<span class="fc" id="L254">        Map&lt;String, Object&gt; trends = getSafeMap(trainedModel, &quot;trends&quot;);</span>
<span class="fc" id="L255">        double surgeryTrend = getSafeDouble(trends, &quot;Chirurgie&quot;);</span>
<span class="fc" id="L256">        double ratio = getSafeDouble(trainedModel, &quot;staffToPatientRatio&quot;);</span>

<span class="fc" id="L258">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L259">        sb.append(format(lang, &quot;SOLUTIONS_HEADER&quot;));</span>

<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (surgeryTrend &gt; 5.0) {</span>
<span class="fc" id="L262">            sb.append(format(lang, &quot;SOL_SURGERY&quot;));</span>
        }

<span class="pc bpc" id="L265" title="1 of 2 branches missed.">        if (ratio &lt; 0.2) {</span>
<span class="fc" id="L266">            sb.append(format(lang, &quot;SOL_STAFF&quot;));</span>
        }

<span class="fc" id="L269">        return sb.toString();</span>
    }

    private String getDoctorOpinion(Language lang) {
<span class="fc" id="L273">        long patients = getSafeLong(trainedModel, &quot;patientCount&quot;);</span>
<span class="fc" id="L274">        double duration = getSafeDouble(trainedModel, &quot;avgStayDuration&quot;);</span>
<span class="fc" id="L275">        return format(lang, &quot;DOC_OPINION&quot;, patients, String.format(&quot;%.1f&quot;, duration));</span>
    }

    private String getAccountantOpinion(Language lang) {
<span class="fc" id="L279">        String revenue = getSafeString(trainedModel, &quot;totalRevenue&quot;);</span>
<span class="fc" id="L280">        Map&lt;String, Object&gt; trends = getSafeMap(trainedModel, &quot;trends&quot;);</span>
<span class="fc" id="L281">        double surgeryTrend = getSafeDouble(trends, &quot;Chirurgie&quot;);</span>
<span class="fc" id="L282">        return format(lang, &quot;ACC_OPINION&quot;, revenue, surgeryTrend);</span>
    }

    private String format(Language lang, String key, Object... args) {
<span class="fc" id="L286">        String template = TEMPLATES.get(lang).getOrDefault(key, key);</span>
<span class="fc" id="L287">        return java.text.MessageFormat.format(template, args);</span>
    }

    private boolean isEnglish(String text) {
<span class="fc" id="L291">        return matchesAny(text, &quot;hello&quot;, &quot;hi&quot;, &quot;what&quot;, &quot;how&quot;, &quot;give&quot;, &quot;opinion&quot;, &quot;cost&quot;, &quot;money&quot;, &quot;forecast&quot;, &quot;future&quot;,</span>
                &quot;staff&quot;, &quot;drug&quot;, &quot;avoid&quot;, &quot;skip&quot;, &quot;prediction&quot;, &quot;talk&quot;, &quot;project&quot;, &quot;solution&quot;, &quot;solve&quot;, &quot;fix&quot;, &quot;help&quot;,
                &quot;alert&quot;, &quot;warning&quot;, &quot;danger&quot;);
    }

    private boolean matchesAny(String text, String... keywords) {
<span class="fc" id="L297">        String[] words = text.split(&quot;\\s+&quot;);</span>
<span class="fc bfc" id="L298" title="All 2 branches covered.">        for (String keyword : keywords) {</span>
<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (text.contains(keyword))</span>
<span class="fc" id="L300">                return true;</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">            for (String word : words) {</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">                int threshold = keyword.length() &gt; 4 ? 2 : 1;</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">                if (calculateLevenshteinDistance(word, keyword) &lt;= threshold) {</span>
<span class="fc" id="L304">                    return true;</span>
                }
            }
        }
<span class="fc" id="L308">        return false;</span>
    }

    private int calculateLevenshteinDistance(String x, String y) {
<span class="fc" id="L312">        int[][] dp = new int[x.length() + 1][y.length() + 1];</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">        for (int i = 0; i &lt;= x.length(); i++)</span>
<span class="fc" id="L314">            dp[i][0] = i;</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">        for (int j = 0; j &lt;= y.length(); j++)</span>
<span class="fc" id="L316">            dp[0][j] = j;</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">        for (int i = 1; i &lt;= x.length(); i++) {</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">            for (int j = 1; j &lt;= y.length(); j++) {</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">                int cost = (x.charAt(i - 1) == y.charAt(j - 1)) ? 0 : 1;</span>
<span class="fc" id="L320">                dp[i][j] = Math.min(Math.min(dp[i - 1][j] + 1, dp[i][j - 1] + 1), dp[i - 1][j - 1] + cost);</span>
            }
        }
<span class="fc" id="L323">        return dp[x.length()][y.length()];</span>
    }

    private double getSafeDouble(Map&lt;String, Object&gt; map, String key) {
<span class="pc bpc" id="L327" title="1 of 2 branches missed.">        if (map == null)</span>
<span class="nc" id="L328">            return 0.0;</span>
<span class="fc" id="L329">        Object value = map.get(key);</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">        if (value == null)</span>
<span class="nc" id="L331">            return 0.0;</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (value instanceof Number)</span>
<span class="fc" id="L333">            return ((Number) value).doubleValue();</span>
        try {
<span class="nc" id="L335">            return Double.parseDouble(String.valueOf(value));</span>
<span class="nc" id="L336">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L337">            return 0.0;</span>
        }
    }

    private long getSafeLong(Map&lt;String, Object&gt; map, String key) {
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        if (map == null)</span>
<span class="nc" id="L343">            return 0L;</span>
<span class="fc" id="L344">        Object value = map.get(key);</span>
<span class="pc bpc" id="L345" title="1 of 2 branches missed.">        if (value == null)</span>
<span class="nc" id="L346">            return 0L;</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">        if (value instanceof Number)</span>
<span class="fc" id="L348">            return ((Number) value).longValue();</span>
        try {
<span class="nc" id="L350">            return Long.parseLong(String.valueOf(value));</span>
<span class="nc" id="L351">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L352">            return 0L;</span>
        }
    }

    private String getSafeString(Map&lt;String, Object&gt; map, String key) {
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">        if (map == null)</span>
<span class="nc" id="L358">            return &quot;&quot;;</span>
<span class="fc" id="L359">        Object value = map.get(key);</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        return value != null ? String.valueOf(value) : &quot;&quot;;</span>
    }

    private Map&lt;String, Object&gt; getSafeMap(Map&lt;String, Object&gt; map, String key) {
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">        if (map == null)</span>
<span class="nc" id="L365">            return new HashMap&lt;&gt;();</span>
<span class="fc" id="L366">        Object value = map.get(key);</span>
<span class="pc bpc" id="L367" title="1 of 2 branches missed.">        if (value instanceof Map) {</span>
<span class="fc" id="L368">            return (Map&lt;String, Object&gt;) value;</span>
        }
<span class="nc" id="L370">        return new HashMap&lt;&gt;();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>